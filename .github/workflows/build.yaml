name: Build, re-usable
on:
  workflow_call:
    inputs:
      channel:
        required: false
        type: string
        default: 'eresept'
      username:
        required: false
        type: string
        default: 'eresept build and test action: ${{ github.event.repository.name }}'
      footer:
        required: false
        type: string
        default: 'eresept Â© 2022'
    secrets:
      webhook:
        required: true
      token:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get start time
        id: starttime
        run: echo "::set-output name=starttime::$(date +%s)"

      - name: Set timezone
        run: sudo timedatectl set-timezone "Europe/Oslo"

      - name: Create settings.xml
        uses: whelk-io/maven-settings-xml-action@v20
        with:
          repositories: '[{ "id": "github", "name": "github", "url": "https://maven.pkg.github.com/navikt/eresept-parent", "releases": { "enabled": "true" }, "snapshots": { "enabled": "false" } }]'
          servers: '[{ "id": "github", "username": "${{ github.actor }}", "password": "${{ secrets.token }}" }]'

      - name: Compile and test
        run: |
          mvn test
        env:
          GITHUB_TOKEN: ${{ secrets.token }}

      - name: Calculate execution time
        id: exectime
        run: |
          END_TIME=$(date +%s)
          echo "::set-output name=exectime::$(( $END_TIME - ${{ steps.starttime.outputs.starttime }} ))"

      - name: Report success?
        if: success()
        env:
          SLACK_CHANNEL: ${{ inputs.channel }}
          SLACK_WEBHOOK: ${{ secrets.webhook }}
          SLACK_USERNAME: "${{ inputs.username }}"
          SLACK_TITLE: "Successfully built _*${{ github.event.repository.name }}*_ in ${{ steps.exectime.outputs.exectime }} seconds"
          SLACK_COLOR: "good"
          SLACK_ICON: https://github.com/github.png?size=48
          SLACK_FOOTER: "${{ inputs.footer }}"
        uses: rtCamp/action-slack-notify@v2
      - name: Report failure?
        if: failure()
        env:
          SLACK_CHANNEL: ${{ inputs.channel }}
          SLACK_WEBHOOK: ${{ secrets.webhook }}
          SLACK_USERNAME: "${{ inputs.username }}"
          SLACK_TITLE: "Build failure in _*${{ github.event.repository.name }}*_"
          SLACK_COLOR: "danger"
          SLACK_ICON: https://github.com/github.png?size=48
          SLACK_FOOTER: "${{ inputs.footer }}"
        uses: rtCamp/action-slack-notify@v2
      - name: Report cancellation?
        if: cancelled()
        env:
          SLACK_CHANNEL: ${{ inputs.channel }}
          SLACK_WEBHOOK: ${{ secrets.webhook }}
          SLACK_USERNAME: "${{ inputs.username }}"
          SLACK_TITLE: "Build of _*${{ github.event.repository.name }}*_ was cancelled"
          SLACK_COLOR: "warning"
          SLACK_ICON: https://github.com/github.png?size=48
          SLACK_FOOTER: "${{ inputs.footer }}"
        uses: rtCamp/action-slack-notify@v2
